name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15
            target: macos-arm
          - os: macos-15-intel
            target: macos-intel

    steps:
    - uses: actions/checkout@v4
    - name: Get Version
      id: get_version
      run: echo "PROJECT_VERSION=$(cat VERSION | tr -d '[:space:]')" >> $GITHUB_ENV

    - name: Install Dependencies
      run: brew install curl gumbo-parser libwebsockets nlohmann-json yaml-cpp cli11 boost

    - name: Configure & Build
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release

    - name: Rename & Upload
      run: |
        mv build/mojo build/mojo-${{ matrix.target }}
        
    - uses: softprops/action-gh-release@v2
      with:
        files: build/mojo-${{ matrix.target }}
        name: Mojo ${{ env.PROJECT_VERSION }}

  build-rpm:
    name: Build Linux (RPM - CentOS Stream 9)
    runs-on: ubuntu-latest
    container: quay.io/centos/centos:stream9
    steps:
    - name: Install Build Tools
      run: |
        dnf -y update
        dnf -y install git cmake make gcc-c++ wget rpm-build epel-release
        dnf config-manager --set-enabled crb
        dnf -y install libcurl-devel gumbo-parser-devel libwebsockets-devel nlohmann-json-devel yaml-cpp-devel cli11-devel libcap-devel libuv-devel libev-devel zlib-devel boost-devel

    - uses: actions/checkout@v4
    - name: Get Version
      id: get_version
      run: echo "PROJECT_VERSION=$(cat VERSION | tr -d '[:space:]')" >> $GITHUB_ENV

    - name: Configure & Build & Package
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DMOJO_STATIC_BUILD=ON
        make -j$(nproc)
        cpack -G RPM

    - name: Upload RPM
      uses: softprops/action-gh-release@v2
      with:
        files: build/*.rpm
        name: Mojo ${{ env.PROJECT_VERSION }}

  build-debian:
    name: Build Linux (DEB - Ubuntu 20.04)
    runs-on: ubuntu-latest
    container: ubuntu:20.04
    steps:
    - name: Install Dependencies
      run: |
        apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get install -y libcurl4-openssl-dev libgumbo-dev libwebsockets-dev nlohmann-json3-dev libyaml-cpp-dev build-essential cmake wget git file libcap-dev libuv1-dev libev-dev zlib1g-dev libboost-all-dev
        # Install CLI11 from jammy deb (safe header-only)
        wget http://archive.ubuntu.com/ubuntu/pool/universe/c/cli11/libcli11-dev_2.1.2+ds-1_all.deb
        dpkg -i libcli11-dev_2.1.2+ds-1_all.deb

    - uses: actions/checkout@v4
    - name: Get Version
      id: get_version
      run: echo "PROJECT_VERSION=$(cat VERSION | tr -d '[:space:]')" >> $GITHUB_ENV

    - name: Configure & Build & Package
      run: |
        mkdir -p build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DMOJO_STATIC_BUILD=ON
        make -j$(nproc)
        cpack -G DEB
        # Rename the raw binary for general use
        cp mojo mojo-linux-x86_64

    - name: Upload Linux Assets
      uses: softprops/action-gh-release@v2
      with:
        files: |
          build/*.deb
          build/mojo-linux-x86_64
        name: Mojo ${{ env.PROJECT_VERSION }}

  build-windows:
    name: Build Windows
    runs-on: windows-2022
    strategy:
      matrix:
        triplet: [x64-windows]
    steps:
    - uses: actions/checkout@v4
    - name: Get Version
      id: get_version
      shell: bash
      run: echo "PROJECT_VERSION=$(cat VERSION | tr -d '[:space:]')" >> $GITHUB_ENV

    - name: Install Dependencies
      run: |
        vcpkg install curl gumbo nlohmann-json libwebsockets yaml-cpp cli11 boost --triplet ${{ matrix.triplet }}
        vcpkg integrate install

    - name: Configure & Build
      shell: bash
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }}
        cmake --build . --config Release
        # Rename to specific name
        mv Release/mojo.exe Release/mojo-windows-x64.exe

    - name: Rename & Upload
      uses: softprops/action-gh-release@v2
      with:
        files: build/Release/mojo-windows-x64.exe
        name: Mojo ${{ env.PROJECT_VERSION }}
